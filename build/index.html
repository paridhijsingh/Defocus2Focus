<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Defocus2Focus - Where Procrastination Meets Play</title>
    <script src="assets/audio/audio-manager.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Splash Screen */
      .splash-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeOut 2s ease-in-out 3s forwards;
      }

      @keyframes fadeOut {
        to {
          opacity: 0;
          visibility: hidden;
        }
      }

      .splash-content {
        text-align: center;
        color: white;
      }

      .splash-title {
        font-size: 3em;
        font-weight: bold;
        margin-bottom: 10px;
        animation: bounce 2s infinite;
      }

      @keyframes bounce {
        0%,
        20%,
        50%,
        80%,
        100% {
          transform: translateY(0);
        }
        40% {
          transform: translateY(-10px);
        }
        60% {
          transform: translateY(-5px);
        }
      }

      .splash-tagline {
        font-size: 1.2em;
        margin-bottom: 30px;
        opacity: 0.9;
      }

      .start-button {
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid white;
        color: white;
        padding: 15px 30px;
        border-radius: 25px;
        font-size: 1.1em;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .start-button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: scale(1.05);
      }

      /* Main App */
      .app {
        display: none;
        animation: fadeIn 1s ease-in-out;
      }

      /* Todo Screen Styles */
      .todo-screen {
        display: block;
        animation: fadeIn 1s ease-in-out;
      }

      .back-button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
      }

      .back-button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateX(-5px);
      }

      .progress-section {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        backdrop-filter: blur(10px);
      }

      .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        color: white;
        font-weight: 600;
      }

      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #3b82f6);
        border-radius: 4px;
        transition: width 0.5s ease;
      }

      .progress-stats {
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        text-align: center;
      }

      .filters-section {
        margin-bottom: 20px;
      }

      .filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        justify-content: center;
      }

      .filter-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .filter-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
      }

      .filter-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      }

      .add-task-btn {
        width: 100%;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        border: none;
        color: white;
        padding: 15px;
        border-radius: 12px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
      }

      .add-task-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
      }

      .tasks-container {
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 10px;
      }

      .task-item {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }

      .task-item:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .task-item.completed {
        opacity: 0.7;
        background: rgba(16, 185, 129, 0.1);
      }

      .task-main {
        display: flex;
        align-items: flex-start;
        gap: 15px;
      }

      .task-checkbox {
        width: 24px;
        height: 24px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        background: transparent;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.3s ease;
        flex-shrink: 0;
        margin-top: 2px;
      }

      .task-checkbox:hover {
        border-color: #10b981;
        background: rgba(16, 185, 129, 0.1);
      }

      .task-checkbox.checked {
        background: #10b981;
        border-color: #10b981;
      }

      .task-content {
        flex: 1;
      }

      .task-title {
        color: white;
        font-size: 16px;
        font-weight: 600;
        margin: 0 0 5px 0;
        line-height: 1.4;
      }

      .task-item.completed .task-title {
        text-decoration: line-through;
        opacity: 0.7;
      }

      .task-description {
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        margin: 0 0 10px 0;
        line-height: 1.4;
      }

      .task-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .category-tag,
      .priority-tag,
      .due-date-tag,
      .time-tag {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .time-tag {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.8);
      }

      .task-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .action-btn {
        width: 32px;
        height: 32px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.1);
        color: white;
      }

      .action-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
      }

      .edit-btn:hover {
        background: rgba(99, 102, 241, 0.3);
      }

      .delete-btn:hover {
        background: rgba(239, 68, 68, 0.3);
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: rgba(255, 255, 255, 0.8);
      }

      .empty-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .empty-state h3 {
        color: white;
        margin: 0 0 10px 0;
        font-size: 18px;
      }

      .empty-state p {
        margin: 0;
        font-size: 14px;
      }

      /* Modal Styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background: white;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 1px solid #e5e7eb;
      }

      .modal-header h3 {
        margin: 0;
        color: #1f2937;
        font-size: 20px;
        font-weight: 600;
      }

      .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: #6b7280;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .close-btn:hover {
        background: #f3f4f6;
        color: #374151;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #374151;
        font-weight: 500;
        font-size: 14px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s ease;
        box-sizing: border-box;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .form-group textarea {
        resize: vertical;
        min-height: 80px;
      }

      .modal-actions {
        display: flex;
        gap: 12px;
        padding: 20px;
        border-top: 1px solid #e5e7eb;
      }

      .modal-actions button {
        flex: 1;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        color: #374151;
      }

      .modal-actions button:hover {
        border-color: #3b82f6;
        color: #3b82f6;
      }

      .modal-actions button[type="submit"] {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }

      .modal-actions button[type="submit"]:hover {
        background: #1d4ed8;
        border-color: #1d4ed8;
      }

      .delete-btn {
        background: #ef4444 !important;
        border-color: #ef4444 !important;
        color: white !important;
      }

      .delete-btn:hover {
        background: #dc2626 !important;
        border-color: #dc2626 !important;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .app-title {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .app-tagline {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.1);
        padding: 15px 20px;
        border-radius: 15px;
        margin-bottom: 30px;
        color: white;
      }

      .status-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .feature-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      }

      .feature-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
      }

      .feature-icon {
        font-size: 3em;
        margin-bottom: 15px;
      }

      .feature-title {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
      }

      .feature-description {
        color: #666;
        line-height: 1.5;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        animation: fadeIn 0.3s ease-in-out;
      }

      .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        animation: slideIn 0.3s ease-in-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translate(-50%, -60%);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%);
        }
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }

      .modal-title {
        font-size: 1.8em;
        font-weight: bold;
        color: #333;
      }

      .close-button {
        background: none;
        border: none;
        font-size: 2em;
        cursor: pointer;
        color: #666;
        padding: 0;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.3s ease;
      }

      .close-button:hover {
        background: #f0f0f0;
      }

      /* Defocus Time Specific Styles */
      .timer-container {
        text-align: center;
        margin-bottom: 30px;
      }

      .timer-display {
        font-size: 4em;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 20px;
        font-family: monospace;
      }

      .timer-controls {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 30px;
      }

      .timer-button {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-size: 1em;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .start-timer {
        background: #28a745;
        color: white;
      }

      .pause-timer {
        background: #ffc107;
        color: #333;
      }

      .reset-timer {
        background: #dc3545;
        color: white;
      }

      .timer-button:hover {
        transform: scale(1.05);
      }

      .time-selector {
        margin-bottom: 20px;
      }

      .time-selector select {
        padding: 10px 15px;
        border: 2px solid #667eea;
        border-radius: 10px;
        font-size: 1em;
        background: white;
      }

      .defocus-activities {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .activity-card {
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .activity-card:hover {
        border-color: #667eea;
        background: #f0f4ff;
      }

      .activity-icon {
        font-size: 2em;
        margin-bottom: 10px;
      }

      /* Mini Game Styles */
      .game-container {
        text-align: center;
        margin: 20px 0;
      }

      .game-canvas {
        border: 2px solid #667eea;
        border-radius: 10px;
        background: #f8f9fa;
        margin: 20px auto;
        display: block;
      }

      .game-controls {
        margin: 20px 0;
      }

      /* Journal Styles */
      .journal-container {
        margin: 20px 0;
      }

      .journal-textarea {
        width: 100%;
        min-height: 200px;
        padding: 15px;
        border: 2px solid #e9ecef;
        border-radius: 10px;
        font-size: 1em;
        font-family: inherit;
        resize: vertical;
      }

      .journal-textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .journal-save {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 1em;
        cursor: pointer;
        margin-top: 15px;
      }

      /* Scribble Styles */
      .scribble-container {
        text-align: center;
        margin: 20px 0;
      }

      .scribble-canvas {
        border: 2px solid #667eea;
        border-radius: 10px;
        background: white;
        margin: 20px auto;
        display: block;
        cursor: crosshair;
      }

      .scribble-controls {
        margin: 20px 0;
      }

      .color-picker {
        margin: 0 10px;
      }

      .brush-size {
        margin: 0 10px;
      }

      .clear-button {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 15px;
        cursor: pointer;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .splash-title {
          font-size: 2em;
        }

        .app-title {
          font-size: 2em;
        }

        .feature-grid {
          grid-template-columns: 1fr;
        }

        .timer-display {
          font-size: 3em;
        }

        .modal-content {
          padding: 20px;
          margin: 20px;
        }
      }

      /* Focus Session Styles */
      .focus-tips {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
      }

      .focus-tips h3 {
        margin-bottom: 15px;
        color: #333;
      }

      .focus-tips ul {
        list-style: none;
        padding: 0;
      }

      .focus-tips li {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        color: #666;
      }

      .focus-tips li:last-child {
        border-bottom: none;
      }

      .timer-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }

      .timer-controls button {
        padding: 12px 24px;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .timer-controls button:nth-child(1) {
        background: #10b981;
        color: white;
      }

      .timer-controls button:nth-child(2) {
        background: #f59e0b;
        color: white;
      }

      .timer-controls button:nth-child(3) {
        background: #ef4444;
        color: white;
      }

      .timer-controls button:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      /* Music Modal Styles */
      .music-modal {
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
      }

      .current-track {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
      }

      .track-info {
        margin-bottom: 15px;
      }

      .track-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 5px;
      }

      .track-category {
        font-size: 14px;
        opacity: 0.8;
      }

      .audio-info {
        font-size: 12px;
        opacity: 0.7;
        margin-top: 5px;
        font-style: italic;
      }

      .audio-visualizer {
        margin: 15px 0;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      #visualizerCanvas {
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
      }

      .track-progress {
        margin-top: 15px;
      }

      .progress-bar {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 3px;
        overflow: hidden;
        margin-bottom: 10px;
      }

      .progress-fill {
        height: 100%;
        background: white;
        width: 0%;
        transition: width 0.1s ease;
      }

      .time-display {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        opacity: 0.8;
      }

      .audio-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 15px;
      }

      .control-btn {
        width: 50px;
        height: 50px;
        border: none;
        border-radius: 50%;
        background: #667eea;
        color: white;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .control-btn:hover {
        background: #5a6fd8;
        transform: scale(1.1);
      }

      .play-btn {
        width: 60px;
        height: 60px;
        font-size: 24px;
        background: #10b981;
      }

      .play-btn:hover {
        background: #059669;
      }

      .stop-btn {
        background: #ef4444;
      }

      .stop-btn:hover {
        background: #dc2626;
      }

      .volume-control {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: 20px;
      }

      .volume-control input[type="range"] {
        width: 100px;
        height: 6px;
        border-radius: 3px;
        background: #ddd;
        outline: none;
        -webkit-appearance: none;
      }

      .volume-control input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #667eea;
        cursor: pointer;
      }

      .shortcuts-info {
        text-align: center;
        margin-top: 10px;
        padding: 8px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        color: #667eea;
      }

      .shortcuts-info small {
        font-size: 12px;
        opacity: 0.8;
      }

      /* Break Time & Rewards Styles */
      .break-time-screen,
      .rewards-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 1000;
        overflow-y: auto;
      }

      .screen-header {
        display: flex;
        align-items: center;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
      }

      .back-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        margin-right: 16px;
        transition: all 0.3s ease;
      }

      .back-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateX(-2px);
      }

      .screen-header h2 {
        color: white;
        margin: 0;
        font-size: 24px;
        font-weight: bold;
      }

      .break-content,
      .rewards-content {
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
      }

      /* Break Type Selector */
      .break-type-selector {
        background: white;
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .break-type-selector h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 20px;
        font-weight: bold;
      }

      .break-types {
        display: flex;
        gap: 16px;
        justify-content: center;
      }

      .break-type {
        background: #f8f9fa;
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        min-width: 120px;
      }

      .break-type:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
      }

      .break-type.selected {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border-color: #4caf50;
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(76, 175, 80, 0.3);
      }

      .break-icon {
        font-size: 32px;
        margin-bottom: 8px;
      }

      .break-name {
        font-weight: bold;
        margin-bottom: 4px;
      }

      .break-duration {
        font-size: 14px;
        opacity: 0.8;
      }

      /* Break Timer */
      .break-timer {
        background: white;
        border-radius: 20px;
        padding: 32px;
        margin-bottom: 24px;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .timer-display {
        margin-bottom: 32px;
      }

      .timer-time {
        font-size: 48px;
        font-weight: bold;
        color: #333;
        font-family: "Courier New", monospace;
        margin-bottom: 16px;
      }

      .timer-progress {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
      }

      .progress-bar {
        height: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #45a049);
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      .timer-controls {
        display: flex;
        gap: 16px;
        justify-content: center;
      }

      .control-btn {
        background: #4caf50;
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
        min-width: 120px;
      }

      .control-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
      }

      .control-btn.pause-btn {
        background: #ff9800;
      }

      .control-btn.stop-btn {
        background: #f44336;
      }

      /* Break Activities */
      .break-activities {
        background: white;
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .break-activities h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 20px;
        font-weight: bold;
      }

      .activity-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
      }

      .activity-card {
        background: #f8f9fa;
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }

      .activity-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        border-color: #4caf50;
      }

      .activity-icon {
        font-size: 32px;
        margin-bottom: 8px;
      }

      .activity-name {
        font-weight: bold;
        margin-bottom: 4px;
        color: #333;
      }

      .activity-desc {
        font-size: 12px;
        color: #666;
        line-height: 1.4;
      }

      /* Break Stats */
      .break-stats {
        background: white;
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .break-stats h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 20px;
        font-weight: bold;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
      }

      .stat-item {
        text-align: center;
        padding: 16px;
        background: #f8f9fa;
        border-radius: 12px;
      }

      .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #4caf50;
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 14px;
        color: #666;
      }

      /* Rewards Styles */
      .level-card {
        background: white;
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .level-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
      }

      .level-icon {
        font-size: 32px;
        margin-right: 16px;
      }

      .level-title {
        font-size: 24px;
        font-weight: bold;
        color: #333;
        margin-bottom: 4px;
      }

      .level-points {
        color: #666;
        font-size: 16px;
      }

      .level-progress {
        margin-bottom: 16px;
      }

      .progress-text {
        text-align: center;
        color: #666;
        font-size: 14px;
        margin-top: 8px;
      }

      .daily-goal-card,
      .streak-card,
      .achievements-card,
      .points-history {
        background: white;
        border-radius: 20px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      .daily-goal-card h3,
      .streak-card h3,
      .achievements-card h3,
      .points-history h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 20px;
        font-weight: bold;
      }

      .goal-progress-bar {
        height: 12px;
        background: #f0f0f0;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 8px;
      }

      .goal-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #45a049);
        border-radius: 6px;
        transition: width 0.3s ease;
      }

      .goal-text {
        text-align: center;
        color: #333;
        font-weight: bold;
        margin-bottom: 12px;
      }

      .goal-completed {
        text-align: center;
        color: #4caf50;
        font-weight: bold;
        background: #e8f5e8;
        padding: 12px;
        border-radius: 12px;
      }

      .streak-display {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 12px;
      }

      .streak-icon {
        font-size: 40px;
        margin-right: 16px;
      }

      .streak-number {
        font-size: 32px;
        font-weight: bold;
        color: #ff6b35;
        margin-bottom: 4px;
      }

      .streak-label {
        color: #666;
        font-size: 16px;
      }

      .streak-description {
        text-align: center;
        color: #666;
        font-style: italic;
      }

      .achievements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
      }

      .achievement-badge {
        background: #f8f9fa;
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        border: 2px solid #e0e0e0;
        transition: all 0.3s ease;
      }

      .achievement-badge.unlocked {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        border-color: #4caf50;
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(76, 175, 80, 0.3);
      }

      .achievement-icon {
        font-size: 32px;
        margin-bottom: 8px;
      }

      .achievement-name {
        font-weight: bold;
        margin-bottom: 4px;
      }

      .achievement-desc {
        font-size: 12px;
        opacity: 0.8;
        line-height: 1.4;
      }

      .activity-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .activity-item {
        display: flex;
        align-items: center;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 12px;
      }

      .activity-item .activity-icon {
        font-size: 20px;
        margin-right: 12px;
      }

      .activity-item .activity-desc {
        flex: 1;
        color: #333;
        font-size: 14px;
      }

      .activity-item .activity-points {
        color: #4caf50;
        font-weight: bold;
        font-size: 14px;
      }

      /* Notification Toast */
      .notification-toast {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(-100px);
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        z-index: 2000;
        font-weight: bold;
        transition: all 0.3s ease;
        max-width: 90%;
        text-align: center;
      }

      .notification-toast.show {
        transform: translateX(-50%) translateY(0);
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .break-types {
          flex-direction: column;
          align-items: center;
        }

        .break-type {
          width: 100%;
          max-width: 200px;
        }

        .timer-controls {
          flex-direction: column;
          align-items: center;
        }

        .control-btn {
          width: 100%;
          max-width: 200px;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .achievements-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .music-categories {
        margin-bottom: 30px;
      }

      .category-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .category-tab {
        padding: 10px 20px;
        border: 2px solid #e5e7eb;
        background: white;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
      }

      .category-tab.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .category-tab:hover {
        border-color: #667eea;
        color: #667eea;
      }

      .category-tab.active:hover {
        color: white;
      }

      .category-content {
        display: none;
      }

      .category-content.active {
        display: block;
      }

      .track-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
      }

      .track-item {
        background: white;
        border: 2px solid #e5e7eb;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .track-item:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .track-item.playing {
        border-color: #10b981;
        background: #f0fdf4;
      }

      .track-icon {
        font-size: 32px;
        margin-bottom: 10px;
      }

      .track-name {
        font-weight: 500;
        color: #374151;
      }

      .playlist-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 15px;
      }

      .playlist-section h3 {
        margin-bottom: 15px;
        color: #374151;
      }

      .playlist-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .playlist-btn {
        padding: 8px 16px;
        border: 2px solid #e5e7eb;
        background: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
      }

      .playlist-btn:hover {
        border-color: #667eea;
        color: #667eea;
      }

      .playlist {
        max-height: 200px;
        overflow-y: auto;
      }

      .playlist-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background: white;
        border-radius: 10px;
        margin-bottom: 5px;
        border: 1px solid #e5e7eb;
      }

      .playlist-item-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .playlist-item-actions {
        display: flex;
        gap: 5px;
      }

      .playlist-item-btn {
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 50%;
        background: #f3f4f6;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .playlist-item-btn:hover {
        background: #e5e7eb;
      }

      .playlist-empty {
        text-align: center;
        color: #9ca3af;
        padding: 20px;
        font-style: italic;
      }

      @media (max-width: 768px) {
        .music-modal {
          margin: 10px;
          max-width: calc(100vw - 20px);
        }

        .track-grid {
          grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        }

        .audio-controls {
          flex-wrap: wrap;
          gap: 15px;
        }

        .category-tabs {
          justify-content: center;
        }

        .playlist-controls {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <!-- Splash Screen -->
    <div class="splash-screen" id="splashScreen">
      <div class="splash-content">
        <div class="splash-title">üéÆ Defocus2Focus</div>
        <div class="splash-tagline">Where Procrastination Meets Play</div>
        <div class="splash-tagline">Gamified Focus & Productivity App</div>
        <button class="start-button" onclick="startApp()">
          Start Your Journey
        </button>
      </div>
    </div>

    <!-- Main App -->
    <div class="app" id="mainApp">
      <div class="container">
        <!-- Header -->
        <div class="header">
          <div class="app-title">üéÆ Defocus2Focus</div>
          <div class="app-tagline">Where Procrastination Meets Play</div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
          <div class="status-item">
            <span>‚≠ê</span>
            <span>Level <span id="userLevel">1</span></span>
          </div>
          <div class="status-item">
            <span>ü™ô</span>
            <span><span id="userCoins">0</span></span>
          </div>
          <div class="status-item">
            <span>üî•</span>
            <span><span id="userEnergy">0</span></span>
          </div>
        </div>

        <!-- Session Debug Panel -->
        <div
          id="sessionDebug"
          style="
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            z-index: 1000;
          "
        >
          <div><strong>Session Debug</strong></div>
          <div>
            Defocus Available: <span id="debugDefocusAvailable">‚úÖ</span>
          </div>
          <div>Defocus Locked: <span id="debugDefocusLocked">‚ùå</span></div>
          <div>Focus Active: <span id="debugFocusActive">‚ùå</span></div>
          <div>Defocus Used: <span id="debugDefocusUsed">‚ùå</span></div>
          <div>Cycles Today: <span id="debugCyclesToday">0</span></div>
        </div>

        <!-- Welcome Message -->
        <div style="text-align: center; color: white; margin-bottom: 30px">
          <h2>Welcome to Defocus2Focus!</h2>
          <p>Choose your next adventure</p>
        </div>

        <!-- Feature Grid -->
        <div class="feature-grid">
          <div class="feature-card" onclick="openDefocusTime()">
            <div class="feature-icon">üåø</div>
            <div class="feature-title">Defocus Time</div>
            <div class="feature-description">
              Take a mindful break with mini-games, journaling, and creative
              activities
            </div>
          </div>

          <div class="feature-card" onclick="openTodoList()">
            <div class="feature-icon">‚úÖ</div>
            <div class="feature-title">My Tasks</div>
            <div class="feature-description">
              Create and manage your to-do list with smart organization
            </div>
          </div>

          <div class="feature-card" onclick="openFocusSession()">
            <div class="feature-icon">‚è∞</div>
            <div class="feature-title">Focus Session</div>
            <div class="feature-description">
              Pomodoro timer to boost your productivity and focus
            </div>
          </div>

          <div class="feature-card" onclick="openMusicRelax()">
            <div class="feature-icon">üéµ</div>
            <div class="feature-title">Music & Relax</div>
            <div class="feature-description">
              Background sounds and music for relaxation and focus
            </div>
          </div>

          <div class="feature-card" onclick="openBreakTime()">
            <div class="feature-icon">‚òï</div>
            <div class="feature-title">Break Time</div>
            <div class="feature-description">
              Guided breaks with activity suggestions and motivation
            </div>
          </div>

          <div class="feature-card" onclick="openRewards()">
            <div class="feature-icon">üèÜ</div>
            <div class="feature-title">Rewards</div>
            <div class="feature-description">
              Track your progress and earn rewards for your achievements
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Defocus Time Modal -->
    <div class="modal" id="defocusModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">üåø Defocus Time</div>
          <button class="close-button" onclick="closeModal('defocusModal')">
            &times;
          </button>
        </div>

        <div class="timer-container">
          <div class="time-selector">
            <label for="defocusTime">Select Defocus Duration:</label>
            <select id="defocusTime">
              <option value="5">5 minutes</option>
              <option value="10" selected>10 minutes</option>
              <option value="15">15 minutes</option>
              <option value="20">20 minutes</option>
              <option value="30">30 minutes</option>
            </select>
          </div>

          <div class="timer-display" id="timerDisplay">10:00</div>

          <div class="timer-controls">
            <button
              class="timer-button start-timer"
              onclick="startDefocusTimer()"
            >
              Start Timer
            </button>
            <button
              class="timer-button pause-timer"
              onclick="pauseDefocusTimer()"
              style="display: none"
            >
              Pause
            </button>
            <button
              class="timer-button reset-timer"
              onclick="resetDefocusTimer()"
            >
              Reset
            </button>
          </div>
        </div>

        <div class="defocus-activities">
          <div class="activity-card" onclick="openMiniGame()">
            <div class="activity-icon">üéÆ</div>
            <div class="feature-title">Mini Games</div>
            <div class="feature-description">
              Quick brain teasers and puzzles
            </div>
          </div>

          <div class="activity-card" onclick="openJournal()">
            <div class="activity-icon">üìù</div>
            <div class="feature-title">Journal</div>
            <div class="feature-description">Write your thoughts and ideas</div>
          </div>

          <div class="activity-card" onclick="openScribble()">
            <div class="activity-icon">‚úèÔ∏è</div>
            <div class="feature-title">Scribble</div>
            <div class="feature-description">Draw and doodle freely</div>
          </div>

          <div class="activity-card" onclick="openTherapist()">
            <div class="activity-icon">ü§ñ</div>
            <div class="feature-title">AI Therapist</div>
            <div class="feature-description">Chat with a supportive bot</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mini Game Modal -->
    <div class="modal" id="miniGameModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">üéÆ Mini Games</div>
          <button class="close-button" onclick="closeModal('miniGameModal')">
            &times;
          </button>
        </div>

        <div class="game-container">
          <canvas
            id="gameCanvas"
            class="game-canvas"
            width="400"
            height="300"
          ></canvas>
          <div class="game-controls">
            <button onclick="startSnakeGame()">Snake Game</button>
            <button onclick="startTetrisGame()">Tetris</button>
            <button onclick="startPuzzleGame()">Puzzle</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Journal Modal -->
    <div class="modal" id="journalModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">üìù Journal</div>
          <button class="close-button" onclick="closeModal('journalModal')">
            &times;
          </button>
        </div>

        <div class="journal-container">
          <textarea
            class="journal-textarea"
            id="journalText"
            placeholder="Write your thoughts, ideas, or anything on your mind..."
          ></textarea>
          <button class="journal-save" onclick="saveJournal()">
            Save Entry
          </button>
        </div>
      </div>
    </div>

    <!-- Scribble Modal -->
    <div class="modal" id="scribbleModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">‚úèÔ∏è Scribble</div>
          <button class="close-button" onclick="closeModal('scribbleModal')">
            &times;
          </button>
        </div>

        <div class="scribble-container">
          <canvas
            id="scribbleCanvas"
            class="scribble-canvas"
            width="500"
            height="400"
          ></canvas>
          <div class="scribble-controls">
            <input
              type="color"
              id="colorPicker"
              class="color-picker"
              value="#000000"
            />
            <input
              type="range"
              id="brushSize"
              class="brush-size"
              min="1"
              max="20"
              value="5"
            />
            <button class="clear-button" onclick="clearScribble()">
              Clear
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- AI Therapist Modal -->
    <div class="modal" id="therapistModal">
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">ü§ñ AI Therapist</div>
          <button class="close-button" onclick="closeModal('therapistModal')">
            &times;
          </button>
        </div>

        <div
          id="chatContainer"
          style="
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
          "
        >
          <div style="color: #667eea; font-weight: bold">
            AI Therapist: Hello! I'm here to listen and support you. How are you
            feeling today?
          </div>
        </div>

        <div style="display: flex; gap: 10px">
          <input
            type="text"
            id="chatInput"
            placeholder="Type your message..."
            style="
              flex: 1;
              padding: 10px;
              border: 1px solid #ccc;
              border-radius: 5px;
            "
          />
          <button
            onclick="sendMessage()"
            style="
              padding: 10px 20px;
              background: #667eea;
              color: white;
              border: none;
              border-radius: 5px;
              cursor: pointer;
            "
          >
            Send
          </button>
        </div>
      </div>
    </div>

    <script>
      // Global variables
      let defocusTimer = null;
      let defocusTimeLeft = 600; // 10 minutes in seconds
      let isTimerRunning = false;
      let userData = {
        level: 1,
        coins: 0,
        energy: 0,
        journalEntries: [],
        completedTasks: 0,
      };

      // Session Cycle State Management
      let sessionState = {
        isDefocusUsed: false,
        isFocusActive: false,
        isDefocusLocked: false,
        completedCyclesToday: 0,
        lastCycleDate: new Date().toDateString(),
      };

      // Load user data from localStorage
      function loadUserData() {
        const saved = localStorage.getItem("defocus2focus_userdata");
        if (saved) {
          userData = { ...userData, ...JSON.parse(saved) };
          updateStatusBar();
        }
      }

      // Save user data to localStorage
      function saveUserData() {
        localStorage.setItem(
          "defocus2focus_userdata",
          JSON.stringify(userData)
        );
      }

      // Load session state from localStorage
      function loadSessionState() {
        const saved = localStorage.getItem("focusSessionState");
        if (saved) {
          const parsed = JSON.parse(saved);
          // Check if we need to reset daily counters
          const today = new Date().toDateString();
          if (parsed.lastCycleDate !== today) {
            sessionState = {
              isDefocusUsed: false,
              isFocusActive: false,
              isDefocusLocked: false,
              completedCyclesToday: 0,
              lastCycleDate: today,
            };
          } else {
            sessionState = { ...sessionState, ...parsed };
          }
        }
        updateDefocusLockState();
      }

      // Save session state to localStorage
      function saveSessionState() {
        localStorage.setItem("focusSessionState", JSON.stringify(sessionState));
      }

      // Update defocus lock state
      function updateDefocusLockState() {
        sessionState.isDefocusLocked =
          sessionState.isDefocusUsed || sessionState.isFocusActive;
        console.log("üîí Lock state updated:", sessionState);
        updateDefocusUI();
      }

      // Update defocus UI based on lock state
      function updateDefocusUI() {
        const defocusCard = document.querySelector(
          '.feature-card[onclick="openDefocusTime()"]'
        );
        const defocusIcon = defocusCard?.querySelector(".feature-icon");
        const defocusTitle = defocusCard?.querySelector(".feature-title");

        console.log("üé® Updating defocus UI:", {
          isLocked: sessionState.isDefocusLocked,
          card: defocusCard,
          icon: defocusIcon,
          title: defocusTitle,
        });

        if (sessionState.isDefocusLocked) {
          if (defocusIcon) defocusIcon.textContent = "üîí";
          if (defocusTitle) defocusTitle.textContent = "Defocus Locked";
          if (defocusCard) {
            defocusCard.style.opacity = "0.6";
            defocusCard.style.cursor = "not-allowed";
          }
          console.log("üîí Defocus UI locked");
        } else {
          if (defocusIcon) defocusIcon.textContent = "üåø";
          if (defocusTitle) defocusTitle.textContent = "Defocus Time";
          if (defocusCard) {
            defocusCard.style.opacity = "1";
            defocusCard.style.cursor = "pointer";
          }
          console.log("üåø Defocus UI unlocked");
        }

        // Update debug panel
        updateDebugPanel();
      }

      // Update debug panel
      function updateDebugPanel() {
        const debugPanel = document.getElementById("sessionDebug");
        if (debugPanel) {
          document.getElementById("debugDefocusAvailable").textContent =
            isDefocusAvailable() ? "‚úÖ" : "‚ùå";
          document.getElementById("debugDefocusLocked").textContent =
            sessionState.isDefocusLocked ? "üîí" : "üîì";
          document.getElementById("debugFocusActive").textContent =
            sessionState.isFocusActive ? "üéØ" : "‚è∏Ô∏è";
          document.getElementById("debugDefocusUsed").textContent =
            sessionState.isDefocusUsed ? "‚úÖ" : "‚ùå";
          document.getElementById("debugCyclesToday").textContent =
            sessionState.completedCyclesToday;
        }
      }

      // Check if defocus is available
      function isDefocusAvailable() {
        return !sessionState.isDefocusLocked;
      }

      // Get defocus lock message
      function getDefocusLockMessage() {
        if (sessionState.isFocusActive) {
          return "üéØ Focus session in progress. Defocus will unlock when you complete your session.";
        }
        if (sessionState.isDefocusUsed) {
          return "‚ú® You're ready to focus now! Defocus will unlock after your session.";
        }
        return "üåø Defocus is available!";
      }

      // Start defocus session
      function startDefocusSession(type, duration) {
        console.log("üöÄ Starting defocus session...", {
          type,
          duration,
          isAvailable: isDefocusAvailable(),
        });

        if (!isDefocusAvailable()) {
          alert(`üîí Defocus Locked\n\n${getDefocusLockMessage()}`);
          return false;
        }

        sessionState.isDefocusUsed = true;
        console.log("üìù Session state updated:", sessionState);

        updateDefocusLockState();
        saveSessionState();
        console.log("üåø Defocus session started:", type, duration);
        return true;
      }

      // End defocus session
      function endDefocusSession() {
        console.log("üåø Defocus session ended");
        // Defocus remains locked until focus session is completed
      }

      // Start focus session
      function startFocusSession(duration = 25) {
        sessionState.isFocusActive = true;
        updateDefocusLockState();
        saveSessionState();
        console.log("üéØ Focus session started:", duration);
      }

      // End focus session
      function endFocusSession() {
        const wasDefocusUsed = sessionState.isDefocusUsed;
        const today = new Date().toDateString();

        sessionState.isFocusActive = false;
        sessionState.isDefocusUsed = false; // Unlock defocus
        sessionState.completedCyclesToday =
          sessionState.lastCycleDate === today
            ? sessionState.completedCyclesToday + (wasDefocusUsed ? 1 : 0)
            : 1;
        sessionState.lastCycleDate = today;

        updateDefocusLockState();
        saveSessionState();

        console.log("üéØ Focus session ended, cycle completed:", wasDefocusUsed);

        if (wasDefocusUsed) {
          const message =
            sessionState.completedCyclesToday === 1
              ? "üéâ Great job completing your first focus cycle!"
              : `üéâ Excellent! You've completed ${sessionState.completedCyclesToday} focus cycles today!`;
          alert(message);
        }

        return {
          cycleCompleted: wasDefocusUsed,
          totalCyclesToday: sessionState.completedCyclesToday,
        };
      }

      // Update status bar
      function updateStatusBar() {
        document.getElementById("userLevel").textContent = userData.level;
        document.getElementById("userCoins").textContent = userData.coins;
        document.getElementById("userEnergy").textContent = userData.energy;
      }

      // Start app
      function startApp() {
        document.getElementById("splashScreen").style.display = "none";
        document.getElementById("mainApp").style.display = "block";
        loadUserData();
        loadSessionState();
      }

      // Modal functions
      function openModal(modalId) {
        document.getElementById(modalId).style.display = "block";
      }

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // Defocus Time functions
      function openDefocusTime() {
        if (!isDefocusAvailable()) {
          alert(`üîí Defocus Locked\n\n${getDefocusLockMessage()}`);
          return;
        }
        openModal("defocusModal");
        resetDefocusTimer();
      }

      function startDefocusTimer() {
        console.log("‚è∞ Start defocus timer called", {
          isTimerRunning,
          defocusTimeLeft,
        });

        if (!isTimerRunning) {
          // Start defocus session (this locks defocus)
          const success = startDefocusSession("defocus", defocusTimeLeft / 60);
          console.log("üéØ Defocus session start result:", success);

          if (!success) {
            return; // Session was locked
          }

          isTimerRunning = true;
          document.querySelector(".start-timer").style.display = "none";
          document.querySelector(".pause-timer").style.display = "inline-block";

          defocusTimer = setInterval(() => {
            defocusTimeLeft--;
            updateTimerDisplay();

            if (defocusTimeLeft <= 0) {
              clearInterval(defocusTimer);
              isTimerRunning = false;

              // End defocus session
              endDefocusSession();

              alert(
                "üåø Defocus time complete! ‚ú® You're ready to focus now! Defocus will unlock after your session."
              );
              userData.coins += 5;
              userData.energy += 10;
              saveUserData();
              updateStatusBar();
              closeModal("defocusModal");
            }
          }, 1000);
        }
      }

      function pauseDefocusTimer() {
        if (isTimerRunning) {
          clearInterval(defocusTimer);
          isTimerRunning = false;
          document.querySelector(".start-timer").style.display = "inline-block";
          document.querySelector(".pause-timer").style.display = "none";
        }
      }

      function resetDefocusTimer() {
        clearInterval(defocusTimer);
        isTimerRunning = false;
        defocusTimeLeft =
          parseInt(document.getElementById("defocusTime").value) * 60;
        updateTimerDisplay();
        document.querySelector(".start-timer").style.display = "inline-block";
        document.querySelector(".pause-timer").style.display = "none";
      }

      function updateTimerDisplay() {
        const minutes = Math.floor(defocusTimeLeft / 60);
        const seconds = defocusTimeLeft % 60;
        document.getElementById("timerDisplay").textContent = `${minutes
          .toString()
          .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
      }

      // Mini Game functions
      function openMiniGame() {
        openModal("miniGameModal");
      }

      function startSnakeGame() {
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Simple snake game implementation
        ctx.fillStyle = "#667eea";
        ctx.font = "20px Arial";
        ctx.textAlign = "center";
        ctx.fillText(
          "Snake Game Coming Soon!",
          canvas.width / 2,
          canvas.height / 2
        );
        ctx.fillText("Click to play", canvas.width / 2, canvas.height / 2 + 30);

        canvas.onclick = () => {
          alert("Snake game will be implemented in the next version!");
        };
      }

      function startTetrisGame() {
        alert("Tetris game will be implemented in the next version!");
      }

      function startPuzzleGame() {
        alert("Puzzle game will be implemented in the next version!");
      }

      // Journal functions
      function openJournal() {
        openModal("journalModal");
        loadJournal();
      }

      function saveJournal() {
        const text = document.getElementById("journalText").value;
        if (text.trim()) {
          const entry = {
            text: text,
            date: new Date().toISOString(),
            id: Date.now(),
          };
          userData.journalEntries.push(entry);
          saveUserData();
          alert("Journal entry saved!");
          document.getElementById("journalText").value = "";
        }
      }

      function loadJournal() {
        const textarea = document.getElementById("journalText");
        if (userData.journalEntries.length > 0) {
          const latestEntry =
            userData.journalEntries[userData.journalEntries.length - 1];
          textarea.value = latestEntry.text;
        }
      }

      // Scribble functions
      function openScribble() {
        openModal("scribbleModal");
        initScribble();
      }

      function initScribble() {
        const canvas = document.getElementById("scribbleCanvas");
        const ctx = canvas.getContext("2d");
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        canvas.addEventListener("mousedown", startDrawing);
        canvas.addEventListener("mousemove", draw);
        canvas.addEventListener("mouseup", stopDrawing);
        canvas.addEventListener("mouseout", stopDrawing);

        function startDrawing(e) {
          isDrawing = true;
          [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function draw(e) {
          if (!isDrawing) return;

          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(e.offsetX, e.offsetY);
          ctx.strokeStyle = document.getElementById("colorPicker").value;
          ctx.lineWidth = document.getElementById("brushSize").value;
          ctx.lineCap = "round";
          ctx.stroke();

          [lastX, lastY] = [e.offsetX, e.offsetY];
        }

        function stopDrawing() {
          isDrawing = false;
        }
      }

      function clearScribble() {
        const canvas = document.getElementById("scribbleCanvas");
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      // AI Therapist functions
      function openTherapist() {
        openModal("therapistModal");
      }

      function sendMessage() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();

        if (message) {
          addMessage("You: " + message);
          input.value = "";

          // Simple AI responses
          setTimeout(() => {
            const responses = [
              "That's interesting! Tell me more about how that makes you feel.",
              "I understand. It sounds like you're going through a challenging time.",
              "Thank you for sharing that with me. How can I support you today?",
              "That's a great perspective! What do you think you could do about this?",
              "I hear you. Remember, it's okay to feel this way. What would help you feel better?",
            ];
            const randomResponse =
              responses[Math.floor(Math.random() * responses.length)];
            addMessage("AI Therapist: " + randomResponse);
          }, 1000);
        }
      }

      function addMessage(message) {
        const container = document.getElementById("chatContainer");
        const messageDiv = document.createElement("div");
        messageDiv.style.marginBottom = "10px";
        messageDiv.textContent = message;
        container.appendChild(messageDiv);
        container.scrollTop = container.scrollHeight;
      }

      // Other feature placeholders
      function openTodoList() {
        // Hide main app and show todo screen
        document.getElementById("mainApp").style.display = "none";
        showTodoScreen();
      }

      function showTodoScreen() {
        // Create todo screen HTML
        const todoHTML = `
          <div class="todo-screen" id="todoScreen">
            <div class="container">
              <!-- Header -->
              <div class="header">
                <button class="back-button" onclick="showMainApp()">‚Üê Back</button>
                <div class="app-title">üìù My Tasks</div>
                <div class="app-tagline">Stay organized and productive</div>
              </div>

              <!-- Progress Bar -->
              <div class="progress-section">
                <div class="progress-header">
                  <span>Daily Progress</span>
                  <span id="progressPercentage">0%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-stats" id="progressStats">
                  <span>0 total ‚Ä¢ 0 completed ‚Ä¢ 0 pending</span>
                </div>
              </div>

              <!-- Filters -->
              <div class="filters-section">
                <div class="filter-buttons">
                  <button class="filter-btn active" data-filter="all">All</button>
                  <button class="filter-btn" data-filter="pending">Pending</button>
                  <button class="filter-btn" data-filter="completed">Completed</button>
                  <button class="filter-btn" data-filter="overdue">Overdue</button>
                  <button class="filter-btn" data-filter="work">Work</button>
                  <button class="filter-btn" data-filter="personal">Personal</button>
                </div>
              </div>

              <!-- Add Task Button -->
              <button class="add-task-btn" onclick="showAddTaskModal()">
                ‚ûï Add New Task
              </button>

              <!-- Tasks List -->
              <div class="tasks-container" id="tasksContainer">
                <div class="empty-state">
                  <div class="empty-icon">üìù</div>
                  <h3>No tasks yet!</h3>
                  <p>Add your first task to get started</p>
                </div>
              </div>
            </div>
          </div>
        `;

        // Add todo screen to body
        document.body.insertAdjacentHTML("beforeend", todoHTML);

        // Load and display tasks
        loadAndDisplayTasks();

        // Add event listeners for filters
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            document
              .querySelectorAll(".filter-btn")
              .forEach((b) => b.classList.remove("active"));
            e.target.classList.add("active");
            filterTasks(e.target.dataset.filter);
          });
        });
      }

      function showMainApp() {
        document.getElementById("todoScreen").remove();
        document.getElementById("mainApp").style.display = "block";
      }

      function openFocusSession() {
        // Start focus session (this keeps defocus locked)
        startFocusSession(25); // 25 minutes default

        // Simple focus timer implementation
        let focusTimeLeft = 25 * 60; // 25 minutes in seconds
        let focusTimer = null;

        const focusModal = document.createElement("div");
        focusModal.id = "focusModal";
        focusModal.className = "modal";
        focusModal.innerHTML = `
          <div class="modal-content">
            <div class="modal-header">
              <h2>üéØ Focus Session</h2>
              <span class="close" onclick="closeFocusSession()">&times;</span>
            </div>
            <div class="modal-body">
              <div class="timer-display">
                <div class="timer-circle">
                  <span id="focusTimerDisplay">25:00</span>
                </div>
                <div class="timer-controls">
                  <button id="startFocusBtn" onclick="startFocusTimer()">Start Focus</button>
                  <button id="pauseFocusBtn" onclick="pauseFocusTimer()" style="display:none;">Pause</button>
                  <button id="stopFocusBtn" onclick="stopFocusTimer()">Stop</button>
                </div>
              </div>
              <div class="focus-tips">
                <h3>üí° Focus Tips</h3>
                <ul>
                  <li>Put your phone in another room</li>
                  <li>Close unnecessary browser tabs</li>
                  <li>Set a clear goal for this session</li>
                  <li>Use noise-canceling headphones if available</li>
                </ul>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(focusModal);
        focusModal.style.display = "block";

        // Focus timer functions
        window.startFocusTimer = function () {
          if (!focusTimer) {
            focusTimer = setInterval(() => {
              focusTimeLeft--;
              updateFocusDisplay();

              if (focusTimeLeft <= 0) {
                clearInterval(focusTimer);
                focusTimer = null;
                completeFocusSession();
              }
            }, 1000);

            document.getElementById("startFocusBtn").style.display = "none";
            document.getElementById("pauseFocusBtn").style.display =
              "inline-block";
          }
        };

        window.pauseFocusTimer = function () {
          if (focusTimer) {
            clearInterval(focusTimer);
            focusTimer = null;
            document.getElementById("startFocusBtn").style.display =
              "inline-block";
            document.getElementById("pauseFocusBtn").style.display = "none";
          }
        };

        window.stopFocusTimer = function () {
          if (confirm("Are you sure you want to stop the focus session?")) {
            if (focusTimer) {
              clearInterval(focusTimer);
              focusTimer = null;
            }
            closeFocusSession();
          }
        };

        window.closeFocusSession = function () {
          document.body.removeChild(focusModal);
          endFocusSession(); // This unlocks defocus
        };

        function updateFocusDisplay() {
          const minutes = Math.floor(focusTimeLeft / 60);
          const seconds = focusTimeLeft % 60;
          document.getElementById("focusTimerDisplay").textContent = `${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }

        function completeFocusSession() {
          alert("üéâ Focus session complete! Great job!");
          userData.coins += 10;
          userData.energy += 20;
          saveUserData();
          updateStatusBar();
          closeFocusSession();
        }
      }

      function openMusicRelax() {
        // Create music modal
        const musicModal = document.createElement("div");
        musicModal.id = "musicModal";
        musicModal.className = "modal";
        musicModal.innerHTML = `
          <div class="modal-content music-modal">
            <div class="modal-header">
              <h2>üéµ Music & Relax</h2>
              <span class="close" onclick="closeMusicModal()">&times;</span>
            </div>
            <div class="modal-body">
              <!-- Current Track Display -->
              <div class="current-track">
                <div class="track-info">
                  <div class="track-title" id="currentTrackTitle">Select a track to play</div>
                  <div class="track-category" id="currentTrackCategory"></div>
                  <div class="audio-info">üéµ Using high-quality generated audio for each track</div>
                </div>
                
                <!-- Audio Visualizer -->
                <div class="audio-visualizer" id="audioVisualizer">
                  <canvas id="visualizerCanvas" width="300" height="60"></canvas>
                </div>
                
                <div class="track-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                  </div>
                  <div class="time-display">
                    <span id="currentTime">0:00</span>
                    <span id="totalTime">0:00</span>
                  </div>
                </div>
              </div>

              <!-- Audio Controls -->
              <div class="audio-controls">
                <button class="control-btn" id="prevBtn" onclick="previousTrack()" title="Previous Track">‚èÆÔ∏è</button>
                <button class="control-btn play-btn" id="playPauseBtn" onclick="togglePlayPause()" title="Play/Pause (Space)">‚ñ∂Ô∏è</button>
                <button class="control-btn" id="nextBtn" onclick="nextTrack()" title="Next Track">‚è≠Ô∏è</button>
                <button class="control-btn stop-btn" id="stopBtn" onclick="stopAllAudio()" title="Stop (S)">‚èπÔ∏è</button>
                <div class="volume-control">
                  <span>üîä</span>
                  <input type="range" id="volumeSlider" min="0" max="100" value="50" onchange="setVolume(this.value)" title="Volume Control (‚Üë/‚Üì)">
                  <span id="volumeValue">50%</span>
                </div>
              </div>
              
              <!-- Keyboard Shortcuts Info -->
              <div class="shortcuts-info">
                <small>üí° Keyboard shortcuts: Space (Play/Pause), S (Stop), ‚Üë/‚Üì (Volume)</small>
              </div>

              <!-- Music Categories -->
              <div class="music-categories">
                <div class="category-tabs">
                  <button class="category-tab active" data-category="nature" onclick="switchCategory('nature')">üåø Nature</button>
                  <button class="category-tab" data-category="ambient" onclick="switchCategory('ambient')">üåä Ambient</button>
                  <button class="category-tab" data-category="focus" onclick="switchCategory('focus')">üéØ Focus</button>
                  <button class="category-tab" data-category="relax" onclick="switchCategory('relax')">üßò Relax</button>
                </div>

                <!-- Nature Sounds -->
                <div class="category-content active" id="nature-content">
                  <div class="track-grid">
                    <div class="track-item" onclick="playTrack('rain', 'nature')">
                      <div class="track-icon">üåßÔ∏è</div>
                      <div class="track-name">Rain</div>
                    </div>
                    <div class="track-item" onclick="playTrack('forest', 'nature')">
                      <div class="track-icon">üå≤</div>
                      <div class="track-name">Forest</div>
                    </div>
                    <div class="track-item" onclick="playTrack('ocean', 'nature')">
                      <div class="track-icon">üåä</div>
                      <div class="track-name">Ocean</div>
                    </div>
                    <div class="track-item" onclick="playTrack('thunder', 'nature')">
                      <div class="track-icon">‚õàÔ∏è</div>
                      <div class="track-name">Thunder</div>
                    </div>
                    <div class="track-item" onclick="playTrack('birds', 'nature')">
                      <div class="track-icon">üê¶</div>
                      <div class="track-name">Birds</div>
                    </div>
                    <div class="track-item" onclick="playTrack('wind', 'nature')">
                      <div class="track-icon">üí®</div>
                      <div class="track-name">Wind</div>
                    </div>
                  </div>
                </div>

                <!-- Ambient Sounds -->
                <div class="category-content" id="ambient-content">
                  <div class="track-grid">
                    <div class="track-item" onclick="playTrack('space', 'ambient')">
                      <div class="track-icon">üåå</div>
                      <div class="track-name">Space</div>
                    </div>
                    <div class="track-item" onclick="playTrack('city', 'ambient')">
                      <div class="track-icon">üèôÔ∏è</div>
                      <div class="track-name">City</div>
                    </div>
                    <div class="track-item" onclick="playTrack('cafe', 'ambient')">
                      <div class="track-icon">‚òï</div>
                      <div class="track-name">Caf√©</div>
                    </div>
                    <div class="track-item" onclick="playTrack('library', 'ambient')">
                      <div class="track-icon">üìö</div>
                      <div class="track-name">Library</div>
                    </div>
                    <div class="track-item" onclick="playTrack('fireplace', 'ambient')">
                      <div class="track-icon">üî•</div>
                      <div class="track-name">Fireplace</div>
                    </div>
                    <div class="track-item" onclick="playTrack('train', 'ambient')">
                      <div class="track-icon">üöÇ</div>
                      <div class="track-name">Train</div>
                    </div>
                  </div>
                </div>

                <!-- Focus Music -->
                <div class="category-content" id="focus-content">
                  <div class="track-grid">
                    <div class="track-item" onclick="playTrack('binaural', 'focus')">
                      <div class="track-icon">üß†</div>
                      <div class="track-name">Binaural</div>
                    </div>
                    <div class="track-item" onclick="playTrack('classical', 'focus')">
                      <div class="track-icon">üéº</div>
                      <div class="track-name">Classical</div>
                    </div>
                    <div class="track-item" onclick="playTrack('lofi', 'focus')">
                      <div class="track-icon">üéß</div>
                      <div class="track-name">Lo-Fi</div>
                    </div>
                    <div class="track-item" onclick="playTrack('piano', 'focus')">
                      <div class="track-icon">üéπ</div>
                      <div class="track-name">Piano</div>
                    </div>
                    <div class="track-item" onclick="playTrack('white-noise', 'focus')">
                      <div class="track-icon">üìª</div>
                      <div class="track-name">White Noise</div>
                    </div>
                    <div class="track-item" onclick="playTrack('brown-noise', 'focus')">
                      <div class="track-icon">üì°</div>
                      <div class="track-name">Brown Noise</div>
                    </div>
                  </div>
                </div>

                <!-- Relaxation Music -->
                <div class="category-content" id="relax-content">
                  <div class="track-grid">
                    <div class="track-item" onclick="playTrack('meditation', 'relax')">
                      <div class="track-icon">üßò</div>
                      <div class="track-name">Meditation</div>
                    </div>
                    <div class="track-item" onclick="playTrack('spa', 'relax')">
                      <div class="track-icon">üõÅ</div>
                      <div class="track-name">Spa</div>
                    </div>
                    <div class="track-item" onclick="playTrack('zen', 'relax')">
                      <div class="track-icon">üïØÔ∏è</div>
                      <div class="track-name">Zen</div>
                    </div>
                    <div class="track-item" onclick="playTrack('chimes', 'relax')">
                      <div class="track-icon">üîî</div>
                      <div class="track-name">Chimes</div>
                    </div>
                    <div class="track-item" onclick="playTrack('singing-bowls', 'relax')">
                      <div class="track-icon">ü•£</div>
                      <div class="track-name">Singing Bowls</div>
                    </div>
                    <div class="track-item" onclick="playTrack('flute', 'relax')">
                      <div class="track-icon">üéµ</div>
                      <div class="track-name">Flute</div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Playlist Section -->
              <div class="playlist-section">
                <h3>üéµ My Playlist</h3>
                <div class="playlist-controls">
                  <button class="playlist-btn" onclick="addToPlaylist()">‚ûï Add Current</button>
                  <button class="playlist-btn" onclick="clearPlaylist()">üóëÔ∏è Clear</button>
                  <button class="playlist-btn" onclick="shufflePlaylist()">üîÄ Shuffle</button>
                </div>
                <div class="playlist" id="playlist">
                  <div class="playlist-empty">No tracks in playlist</div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(musicModal);
        musicModal.style.display = "block";

        // Initialize music system
        initializeMusicSystem();
      }

      // Break Time and Rewards System
      let breakState = {
        isBreakActive: false,
        breakTimeRemaining: 0,
        breakType: "short", // micro, short, long
        breakDuration: 5, // minutes
        breakStartTime: null,
        breakInterval: null,
        totalBreaks: 0,
        completedBreaks: 0,
        streak: 0,
        lastBreakDate: null,
      };

      let rewardsState = {
        totalPoints: 0,
        currentLevel: 1,
        pointsToNextLevel: 100,
        focusStreak: 0,
        dailyGoal: 4,
        dailyProgress: 0,
        achievements: [],
        unlockedAchievements: [],
      };

      // Load saved data
      function loadBreakRewardsData() {
        const savedBreakData = localStorage.getItem("breakData");
        const savedRewardsData = localStorage.getItem("rewardsData");

        if (savedBreakData) {
          breakState = { ...breakState, ...JSON.parse(savedBreakData) };
        }

        if (savedRewardsData) {
          rewardsState = { ...rewardsState, ...JSON.parse(savedRewardsData) };
        }
      }

      // Save data
      function saveBreakRewardsData() {
        localStorage.setItem("breakData", JSON.stringify(breakState));
        localStorage.setItem("rewardsData", JSON.stringify(rewardsState));
      }

      // Initialize on page load
      loadBreakRewardsData();
      
      // Force cache refresh - Break Time & Rewards are fully implemented!

      function openBreakTime() {
        hideMainApp();
        showBreakTimeScreen();
      }

      function openRewards() {
        hideMainApp();
        showRewardsScreen();
      }

      // Break Time Screen
      function showBreakTimeScreen() {
        const breakTimeHTML = `
          <div class="break-time-screen">
            <div class="screen-header">
              <button class="back-btn" onclick="showMainApp()">‚Üê Back</button>
              <h2>Break Time</h2>
            </div>
            
            <div class="break-content">
              <!-- Break Type Selector -->
              <div class="break-type-selector">
                <h3>Choose Your Break Type</h3>
                <div class="break-types">
                  <div class="break-type ${
                    breakState.breakType === "micro" ? "selected" : ""
                  }" onclick="selectBreakType('micro')">
                    <div class="break-icon">‚ö°</div>
                    <div class="break-name">Micro Break</div>
                    <div class="break-duration">2 min</div>
                  </div>
                  <div class="break-type ${
                    breakState.breakType === "short" ? "selected" : ""
                  }" onclick="selectBreakType('short')">
                    <div class="break-icon">‚òï</div>
                    <div class="break-name">Short Break</div>
                    <div class="break-duration">5 min</div>
                  </div>
                  <div class="break-type ${
                    breakState.breakType === "long" ? "selected" : ""
                  }" onclick="selectBreakType('long')">
                    <div class="break-icon">üßò</div>
                    <div class="break-name">Long Break</div>
                    <div class="break-duration">15 min</div>
                  </div>
                </div>
              </div>

              <!-- Break Timer -->
              <div class="break-timer">
                <div class="timer-display">
                  <div class="timer-time" id="breakTimerDisplay">${formatBreakTime(
                    breakState.breakTimeRemaining
                  )}</div>
                  <div class="timer-progress">
                    <div class="progress-bar">
                      <div class="progress-fill" id="breakProgressFill" style="width: 0%"></div>
                    </div>
                  </div>
                </div>
                
                <div class="timer-controls">
                  <button class="control-btn start-btn" id="breakStartBtn" onclick="startBreakTimer()">‚ñ∂Ô∏è Start Break</button>
                  <button class="control-btn pause-btn" id="breakPauseBtn" onclick="pauseBreakTimer()" style="display: none;">‚è∏Ô∏è Pause</button>
                  <button class="control-btn stop-btn" onclick="stopBreakTimer()">‚èπÔ∏è Stop</button>
                </div>
              </div>

              <!-- Break Activities -->
              <div class="break-activities">
                <h3>Break Activities</h3>
                <div class="activity-grid">
                  <div class="activity-card" onclick="startBreakActivity('breathing')">
                    <div class="activity-icon">ü´Å</div>
                    <div class="activity-name">Breathing</div>
                    <div class="activity-desc">Deep breathing exercise</div>
                  </div>
                  <div class="activity-card" onclick="startBreakActivity('stretching')">
                    <div class="activity-icon">ü§∏</div>
                    <div class="activity-name">Stretching</div>
                    <div class="activity-desc">Light stretching routine</div>
                  </div>
                  <div class="activity-card" onclick="startBreakActivity('walking')">
                    <div class="activity-icon">üö∂</div>
                    <div class="activity-name">Walking</div>
                    <div class="activity-desc">Take a short walk</div>
                  </div>
                  <div class="activity-card" onclick="startBreakActivity('meditation')">
                    <div class="activity-icon">üßò</div>
                    <div class="activity-name">Meditation</div>
                    <div class="activity-desc">Quick mindfulness</div>
                  </div>
                </div>
              </div>

              <!-- Break Stats -->
              <div class="break-stats">
                <h3>Your Break Stats</h3>
                <div class="stats-grid">
                  <div class="stat-item">
                    <div class="stat-value">${breakState.totalBreaks}</div>
                    <div class="stat-label">Total Breaks</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">${breakState.completedBreaks}</div>
                    <div class="stat-label">Completed</div>
                  </div>
                  <div class="stat-item">
                    <div class="stat-value">${breakState.streak}</div>
                    <div class="stat-label">Day Streak</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", breakTimeHTML);
      }

      // Rewards Screen
      function showRewardsScreen() {
        const rewardsHTML = `
          <div class="rewards-screen">
            <div class="screen-header">
              <button class="back-btn" onclick="showMainApp()">‚Üê Back</button>
              <h2>Rewards & Achievements</h2>
            </div>
            
            <div class="rewards-content">
              <!-- Level Progress -->
              <div class="level-card">
                <div class="level-header">
                  <div class="level-icon">üèÜ</div>
                  <div class="level-info">
                    <div class="level-title">Level ${
                      rewardsState.currentLevel
                    }</div>
                    <div class="level-points">${
                      rewardsState.totalPoints
                    } points</div>
                  </div>
                </div>
                <div class="level-progress">
                  <div class="progress-bar">
                    <div class="progress-fill" style="width: ${
                      ((100 - rewardsState.pointsToNextLevel) / 100) * 100
                    }%"></div>
                  </div>
                  <div class="progress-text">${
                    100 - rewardsState.pointsToNextLevel
                  }/100 points to next level</div>
                </div>
              </div>

              <!-- Daily Goal -->
              <div class="daily-goal-card">
                <h3>Daily Goal</h3>
                <div class="goal-progress">
                  <div class="goal-progress-bar">
                    <div class="goal-progress-fill" style="width: ${
                      (rewardsState.dailyProgress / rewardsState.dailyGoal) *
                      100
                    }%"></div>
                  </div>
                  <div class="goal-text">${rewardsState.dailyProgress}/${
          rewardsState.dailyGoal
        } focus sessions</div>
                </div>
                ${
                  rewardsState.dailyProgress >= rewardsState.dailyGoal
                    ? '<div class="goal-completed">üéâ Daily goal completed!</div>'
                    : ""
                }
              </div>

              <!-- Streak Tracker -->
              <div class="streak-card">
                <h3>Focus Streak</h3>
                <div class="streak-display">
                  <div class="streak-icon">üî•</div>
                  <div class="streak-info">
                    <div class="streak-number">${rewardsState.focusStreak}</div>
                    <div class="streak-label">days</div>
                  </div>
                </div>
                <div class="streak-description">Keep the momentum going!</div>
              </div>

              <!-- Achievements -->
              <div class="achievements-card">
                <h3>Achievements</h3>
                <div class="achievements-grid">
                  <div class="achievement-badge ${
                    rewardsState.totalPoints >= 50 ? "unlocked" : ""
                  }">
                    <div class="achievement-icon">üéØ</div>
                    <div class="achievement-name">Focus Master</div>
                    <div class="achievement-desc">Complete 10 focus sessions</div>
                  </div>
                  <div class="achievement-badge ${
                    rewardsState.totalPoints >= 125 ? "unlocked" : ""
                  }">
                    <div class="achievement-icon">üßò</div>
                    <div class="achievement-name">Zen Master</div>
                    <div class="achievement-desc">Complete 25 focus sessions</div>
                  </div>
                  <div class="achievement-badge ${
                    rewardsState.totalPoints >= 250 ? "unlocked" : ""
                  }">
                    <div class="achievement-icon">üß†</div>
                    <div class="achievement-name">Mind Master</div>
                    <div class="achievement-desc">Complete 50 focus sessions</div>
                  </div>
                  <div class="achievement-badge ${
                    rewardsState.focusStreak >= 7 ? "unlocked" : ""
                  }">
                    <div class="achievement-icon">üî•</div>
                    <div class="achievement-name">Streak Master</div>
                    <div class="achievement-desc">7-day focus streak</div>
                  </div>
                </div>
              </div>

              <!-- Points History -->
              <div class="points-history">
                <h3>Recent Activity</h3>
                <div class="activity-list">
                  <div class="activity-item">
                    <div class="activity-icon">üéØ</div>
                    <div class="activity-desc">Completed focus session</div>
                    <div class="activity-points">+5 points</div>
                  </div>
                  <div class="activity-item">
                    <div class="activity-icon">‚òï</div>
                    <div class="activity-desc">Took a break</div>
                    <div class="activity-points">+2 points</div>
                  </div>
                  <div class="activity-item">
                    <div class="activity-icon">üèÜ</div>
                    <div class="activity-desc">Level up!</div>
                    <div class="activity-points">+10 points</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", rewardsHTML);
      }

      // Break Timer Functions
      function selectBreakType(type) {
        breakState.breakType = type;
        const durations = { micro: 2, short: 5, long: 15 };
        breakState.breakDuration = durations[type];
        breakState.breakTimeRemaining = breakState.breakDuration * 60;

        // Update UI
        document
          .querySelectorAll(".break-type")
          .forEach((el) => el.classList.remove("selected"));
        document
          .querySelector(`[onclick="selectBreakType('${type}')"]`)
          .classList.add("selected");

        // Update timer display
        const timerDisplay = document.getElementById("breakTimerDisplay");
        if (timerDisplay) {
          timerDisplay.textContent = formatBreakTime(
            breakState.breakTimeRemaining
          );
        }

        saveBreakRewardsData();
      }

      function startBreakTimer() {
        if (breakState.breakTimeRemaining === 0) {
          breakState.breakTimeRemaining = breakState.breakDuration * 60;
        }

        breakState.isBreakActive = true;
        breakState.breakStartTime = Date.now();

        // Update UI
        document.getElementById("breakStartBtn").style.display = "none";
        document.getElementById("breakPauseBtn").style.display = "inline-block";

        // Start timer
        breakState.breakInterval = setInterval(() => {
          breakState.breakTimeRemaining--;
          updateBreakTimerDisplay();

          if (breakState.breakTimeRemaining <= 0) {
            completeBreak();
          }
        }, 1000);

        saveBreakRewardsData();
      }

      function pauseBreakTimer() {
        breakState.isBreakActive = false;
        clearInterval(breakState.breakInterval);

        // Update UI
        document.getElementById("breakStartBtn").style.display = "inline-block";
        document.getElementById("breakPauseBtn").style.display = "none";

        saveBreakRewardsData();
      }

      function stopBreakTimer() {
        breakState.isBreakActive = false;
        breakState.breakTimeRemaining = 0;
        clearInterval(breakState.breakInterval);

        // Update UI
        document.getElementById("breakStartBtn").style.display = "inline-block";
        document.getElementById("breakPauseBtn").style.display = "none";
        updateBreakTimerDisplay();

        saveBreakRewardsData();
      }

      function completeBreak() {
        breakState.isBreakActive = false;
        breakState.breakTimeRemaining = 0;
        clearInterval(breakState.breakInterval);

        // Update stats
        breakState.totalBreaks++;
        breakState.completedBreaks++;
        breakState.streak++;
        breakState.lastBreakDate = new Date().toISOString();

        // Add points
        addPoints(2);

        // Update UI
        document.getElementById("breakStartBtn").style.display = "inline-block";
        document.getElementById("breakPauseBtn").style.display = "none";
        updateBreakTimerDisplay();

        // Show completion message
        showNotification("üéâ Break completed! You earned 2 points!");

        saveBreakRewardsData();
      }

      function updateBreakTimerDisplay() {
        const timerDisplay = document.getElementById("breakTimerDisplay");
        const progressFill = document.getElementById("breakProgressFill");

        if (timerDisplay) {
          timerDisplay.textContent = formatBreakTime(
            breakState.breakTimeRemaining
          );
        }

        if (progressFill) {
          const totalTime = breakState.breakDuration * 60;
          const progress =
            ((totalTime - breakState.breakTimeRemaining) / totalTime) * 100;
          progressFill.style.width = `${progress}%`;
        }
      }

      function formatBreakTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, "0")}:${secs
          .toString()
          .padStart(2, "0")}`;
      }

      function startBreakActivity(activity) {
        const activities = {
          breathing:
            "Take 5 deep breaths. Inhale for 4 counts, hold for 4, exhale for 6.",
          stretching:
            "Stand up and stretch your arms, neck, and back. Hold each stretch for 15 seconds.",
          walking:
            "Take a short walk around your space. Even 2-3 minutes helps!",
          meditation:
            "Close your eyes and focus on your breathing. Let thoughts come and go naturally.",
        };

        showNotification(`üßò ${activities[activity]}`);
      }

      // Rewards Functions
      function addPoints(points) {
        rewardsState.totalPoints += points;

        // Check for level up
        const newLevel = Math.floor(rewardsState.totalPoints / 100) + 1;
        if (newLevel > rewardsState.currentLevel) {
          rewardsState.currentLevel = newLevel;
          showNotification(`üéâ Level up! You're now level ${newLevel}!`);
        }

        rewardsState.pointsToNextLevel = 100 - (rewardsState.totalPoints % 100);

        // Update daily progress
        rewardsState.dailyProgress++;
        if (rewardsState.dailyProgress >= rewardsState.dailyGoal) {
          showNotification("üéØ Daily goal completed!");
        }

        saveBreakRewardsData();
      }

      function showNotification(message) {
        // Create notification element
        const notification = document.createElement("div");
        notification.className = "notification-toast";
        notification.textContent = message;

        // Add to page
        document.body.appendChild(notification);

        // Show notification
        setTimeout(() => notification.classList.add("show"), 100);

        // Hide after 3 seconds
        setTimeout(() => {
          notification.classList.remove("show");
          setTimeout(() => notification.remove(), 300);
        }, 3000);
      }

      // Todo management functions
      function loadAndDisplayTasks() {
        const tasks =
          JSON.parse(localStorage.getItem("userData") || "{}").todoList || [];
        displayTasks(tasks);
        updateProgress(tasks);
      }

      function displayTasks(tasks) {
        const container = document.getElementById("tasksContainer");

        if (tasks.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-icon">üìù</div>
              <h3>No tasks yet!</h3>
              <p>Add your first task to get started</p>
            </div>
          `;
          return;
        }

        const tasksHTML = tasks
          .map(
            (task) => `
          <div class="task-item ${
            task.completed ? "completed" : ""
          }" data-task-id="${task.id}">
            <div class="task-main">
              <button class="task-checkbox ${
                task.completed ? "checked" : ""
              }" onclick="toggleTask('${task.id}')">
                ${task.completed ? "‚úì" : ""}
              </button>
              <div class="task-content">
                <h4 class="task-title">${task.text}</h4>
                ${
                  task.description
                    ? `<p class="task-description">${task.description}</p>`
                    : ""
                }
                <div class="task-meta">
                  ${getCategoryTag(task.category)}
                  ${getPriorityTag(task.priority)}
                  ${getDueDateTag(task.dueDate)}
                  ${
                    task.estimatedTime
                      ? `<span class="time-tag">‚è±Ô∏è ${task.estimatedTime}m</span>`
                      : ""
                  }
                </div>
              </div>
              <div class="task-actions">
                <button class="action-btn edit-btn" onclick="editTask('${
                  task.id
                }')">‚úèÔ∏è</button>
                <button class="action-btn delete-btn" onclick="deleteTask('${
                  task.id
                }')">üóëÔ∏è</button>
              </div>
            </div>
          </div>
        `
          )
          .join("");

        container.innerHTML = tasksHTML;
      }

      function getCategoryTag(category) {
        const categories = {
          work: { icon: "üè¢", color: "#3b82f6", name: "Work" },
          personal: { icon: "üë§", color: "#10b981", name: "Personal" },
          study: { icon: "üéì", color: "#8b5cf6", name: "Study" },
          health: { icon: "üí™", color: "#ef4444", name: "Health" },
          shopping: { icon: "üõí", color: "#f59e0b", name: "Shopping" },
        };
        const cat = categories[category] || categories.personal;
        return `<span class="category-tag" style="background-color: ${cat.color}20; color: ${cat.color}">
          ${cat.icon} ${cat.name}
        </span>`;
      }

      function getPriorityTag(priority) {
        const priorities = {
          urgent: { icon: "‚ö†Ô∏è", color: "#ef4444", name: "Urgent" },
          high: { icon: "‚¨ÜÔ∏è", color: "#f59e0b", name: "High" },
          medium: { icon: "‚ûñ", color: "#3b82f6", name: "Medium" },
          low: { icon: "‚¨áÔ∏è", color: "#10b981", name: "Low" },
        };
        const pri = priorities[priority] || priorities.medium;
        return `<span class="priority-tag" style="background-color: ${pri.color}20; color: ${pri.color}">
          ${pri.icon} ${pri.name}
        </span>`;
      }

      function getDueDateTag(dueDate) {
        if (!dueDate) return "";
        const date = new Date(dueDate);
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);

        let text = "";
        let color = "#3b82f6";

        if (date.toDateString() === today.toDateString()) {
          text = "Today";
        } else if (date.toDateString() === tomorrow.toDateString()) {
          text = "Tomorrow";
        } else {
          text = date.toLocaleDateString();
        }

        if (date < today) {
          color = "#ef4444";
        }

        return `<span class="due-date-tag" style="background-color: ${color}20; color: ${color}">
          üìÖ ${text}
        </span>`;
      }

      function updateProgress(tasks) {
        const total = tasks.length;
        const completed = tasks.filter((t) => t.completed).length;
        const pending = total - completed;
        const percentage =
          total > 0 ? Math.round((completed / total) * 100) : 0;

        document.getElementById("progressPercentage").textContent =
          percentage + "%";
        document.getElementById("progressFill").style.width = percentage + "%";
        document.getElementById(
          "progressStats"
        ).textContent = `${total} total ‚Ä¢ ${completed} completed ‚Ä¢ ${pending} pending`;
      }

      function filterTasks(filter) {
        const tasks =
          JSON.parse(localStorage.getItem("userData") || "{}").todoList || [];
        let filteredTasks = tasks;

        switch (filter) {
          case "pending":
            filteredTasks = tasks.filter((t) => !t.completed);
            break;
          case "completed":
            filteredTasks = tasks.filter((t) => t.completed);
            break;
          case "overdue":
            filteredTasks = tasks.filter((t) => {
              if (!t.dueDate || t.completed) return false;
              return new Date(t.dueDate) < new Date();
            });
            break;
          case "work":
          case "personal":
          case "study":
          case "health":
          case "shopping":
            filteredTasks = tasks.filter((t) => t.category === filter);
            break;
        }

        displayTasks(filteredTasks);
      }

      function toggleTask(taskId) {
        const userData = JSON.parse(localStorage.getItem("userData") || "{}");
        const task = userData.todoList.find((t) => t.id === taskId);
        if (task) {
          task.completed = !task.completed;
          localStorage.setItem("userData", JSON.stringify(userData));
          loadAndDisplayTasks();
        }
      }

      function deleteTask(taskId) {
        if (confirm("Are you sure you want to delete this task?")) {
          const userData = JSON.parse(localStorage.getItem("userData") || "{}");
          userData.todoList = userData.todoList.filter((t) => t.id !== taskId);
          localStorage.setItem("userData", JSON.stringify(userData));
          loadAndDisplayTasks();
        }
      }

      function editTask(taskId) {
        const userData = JSON.parse(localStorage.getItem("userData") || "{}");
        const task = userData.todoList.find((t) => t.id === taskId);
        if (task) {
          showAddTaskModal(task);
        }
      }

      function showAddTaskModal(editingTask = null) {
        const modalHTML = `
          <div class="modal-overlay" id="taskModal">
            <div class="modal-content">
              <div class="modal-header">
                <h3>${editingTask ? "Edit Task" : "Add New Task"}</h3>
                <button class="close-btn" onclick="closeTaskModal()">‚úï</button>
              </div>
              <form id="taskForm" onsubmit="saveTask(event, '${
                editingTask ? editingTask.id : ""
              }')">
                <div class="form-group">
                  <label>Task Title *</label>
                  <input type="text" id="taskTitle" value="${
                    editingTask ? editingTask.text : ""
                  }" required>
                </div>
                <div class="form-group">
                  <label>Description</label>
                  <textarea id="taskDescription" rows="3">${
                    editingTask ? editingTask.description || "" : ""
                  }</textarea>
                </div>
                <div class="form-group">
                  <label>Category</label>
                  <select id="taskCategory">
                    <option value="personal" ${
                      editingTask && editingTask.category === "personal"
                        ? "selected"
                        : ""
                    }>üë§ Personal</option>
                    <option value="work" ${
                      editingTask && editingTask.category === "work"
                        ? "selected"
                        : ""
                    }>üè¢ Work</option>
                    <option value="study" ${
                      editingTask && editingTask.category === "study"
                        ? "selected"
                        : ""
                    }>üéì Study</option>
                    <option value="health" ${
                      editingTask && editingTask.category === "health"
                        ? "selected"
                        : ""
                    }>üí™ Health</option>
                    <option value="shopping" ${
                      editingTask && editingTask.category === "shopping"
                        ? "selected"
                        : ""
                    }>üõí Shopping</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Priority</label>
                  <select id="taskPriority">
                    <option value="low" ${
                      editingTask && editingTask.priority === "low"
                        ? "selected"
                        : ""
                    }>‚¨áÔ∏è Low</option>
                    <option value="medium" ${
                      editingTask && editingTask.priority === "medium"
                        ? "selected"
                        : ""
                    }>‚ûñ Medium</option>
                    <option value="high" ${
                      editingTask && editingTask.priority === "high"
                        ? "selected"
                        : ""
                    }>‚¨ÜÔ∏è High</option>
                    <option value="urgent" ${
                      editingTask && editingTask.priority === "urgent"
                        ? "selected"
                        : ""
                    }>‚ö†Ô∏è Urgent</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Due Date</label>
                  <input type="date" id="taskDueDate" value="${
                    editingTask && editingTask.dueDate
                      ? new Date(editingTask.dueDate)
                          .toISOString()
                          .split("T")[0]
                      : ""
                  }">
                </div>
                <div class="form-group">
                  <label>Estimated Time (minutes)</label>
                  <input type="number" id="taskEstimatedTime" value="${
                    editingTask ? editingTask.estimatedTime || "" : ""
                  }" min="1">
                </div>
                <div class="modal-actions">
                  <button type="button" onclick="closeTaskModal()">Cancel</button>
                  ${
                    editingTask
                      ? '<button type="button" onclick="deleteTask(\'' +
                        editingTask.id +
                        '\'); closeTaskModal();" class="delete-btn">Delete</button>'
                      : ""
                  }
                  <button type="submit">${
                    editingTask ? "Save Changes" : "Add Task"
                  }</button>
                </div>
              </form>
            </div>
          </div>
        `;

        document.body.insertAdjacentHTML("beforeend", modalHTML);
      }

      function closeTaskModal() {
        document.getElementById("taskModal").remove();
      }

      function saveTask(event, taskId) {
        event.preventDefault();

        const userData = JSON.parse(localStorage.getItem("userData") || "{}");
        if (!userData.todoList) userData.todoList = [];

        const taskData = {
          text: document.getElementById("taskTitle").value.trim(),
          description: document.getElementById("taskDescription").value.trim(),
          category: document.getElementById("taskCategory").value,
          priority: document.getElementById("taskPriority").value,
          dueDate: document.getElementById("taskDueDate").value
            ? new Date(
                document.getElementById("taskDueDate").value
              ).toISOString()
            : null,
          estimatedTime: document.getElementById("taskEstimatedTime").value
            ? parseInt(document.getElementById("taskEstimatedTime").value)
            : null,
          completed: false,
          createdAt: new Date().toISOString(),
        };

        if (taskId) {
          // Edit existing task
          const taskIndex = userData.todoList.findIndex((t) => t.id === taskId);
          if (taskIndex !== -1) {
            userData.todoList[taskIndex] = {
              ...userData.todoList[taskIndex],
              ...taskData,
            };
          }
        } else {
          // Add new task
          taskData.id = Date.now().toString();
          userData.todoList.push(taskData);
        }

        localStorage.setItem("userData", JSON.stringify(userData));
        closeTaskModal();
        loadAndDisplayTasks();

        alert(
          taskId ? "Task updated successfully!" : "Task added successfully!"
        );
      }

      // Add keyboard shortcuts for audio control
      document.addEventListener("keydown", function (event) {
        // Only handle shortcuts when music modal is open
        const musicModal = document.getElementById("musicModal");
        if (!musicModal || musicModal.style.display !== "block") return;

        switch (event.code) {
          case "Space":
            event.preventDefault();
            togglePlayPause();
            break;
          case "KeyS":
            event.preventDefault();
            stopAllAudio();
            break;
          case "ArrowUp":
            event.preventDefault();
            const currentVolume = window.audioManager
              ? window.audioManager.getVolume() * 100
              : 50;
            const newVolume = Math.min(100, currentVolume + 10);
            setVolume(newVolume);
            break;
          case "ArrowDown":
            event.preventDefault();
            const currentVol = window.audioManager
              ? window.audioManager.getVolume() * 100
              : 50;
            const newVol = Math.max(0, currentVol - 10);
            setVolume(newVol);
            break;
        }
      });

      // Initialize app
      document.addEventListener("DOMContentLoaded", function () {
        // Auto-start app after 3 seconds
        setTimeout(() => {
          if (
            document.getElementById("splashScreen").style.display !== "none"
          ) {
            startApp();
          }
        }, 3000);
      });

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modals = document.querySelectorAll(".modal");
        modals.forEach((modal) => {
          if (event.target === modal) {
            modal.style.display = "none";
          }
        });
      };
      // Music System Variables
      let currentAudio = null;
      let currentTrack = null;
      let currentCategory = null;
      let isPlaying = false;
      let currentPlaylist = [];
      let currentPlaylistIndex = 0;
      let progressInterval = null;
      let visualizerInterval = null;
      let audioContext = null;
      let analyser = null;
      let dataArray = null;

      // Note: Audio sources are now managed by the AudioManager class
      // The audio manager handles both local MP3 files and generated audio fallbacks

      // Initialize Music System
      function initializeMusicSystem() {
        console.log("üéµ Initializing music system...");

        // Load saved preferences
        loadMusicPreferences();

        // Set up audio event listeners
        if (currentAudio) {
          currentAudio.addEventListener("ended", nextTrack);
          currentAudio.addEventListener("timeupdate", updateProgress);
        }

        // Initialize volume
        const savedVolume = localStorage.getItem("musicVolume") || 50;
        const volumeSlider = document.getElementById("volumeSlider");
        if (volumeSlider) {
          volumeSlider.value = savedVolume;
        }
        setVolume(savedVolume);

        console.log("üéµ Music system initialized");
      }

      // Load music preferences from localStorage
      function loadMusicPreferences() {
        const savedPlaylist = localStorage.getItem("musicPlaylist");
        if (savedPlaylist) {
          currentPlaylist = JSON.parse(savedPlaylist);
          updatePlaylistDisplay();
        }

        const savedTrack = localStorage.getItem("currentTrack");
        const savedCategory = localStorage.getItem("currentCategory");
        if (savedTrack && savedCategory) {
          currentTrack = savedTrack;
          currentCategory = savedCategory;
          updateCurrentTrackDisplay();
        }
      }

      // Save music preferences to localStorage
      function saveMusicPreferences() {
        localStorage.setItem("musicPlaylist", JSON.stringify(currentPlaylist));
        if (currentTrack) localStorage.setItem("currentTrack", currentTrack);
        if (currentCategory)
          localStorage.setItem("currentCategory", currentCategory);
      }

      // Play a track using the audio manager
      async function playTrack(trackId, category) {
        console.log("üéµ Playing track:", trackId, "from category:", category);

        // Stop any existing visualizer
        stopVisualizer();

        // Use the audio manager to play the track
        const success = await window.audioManager.playAudio(category, trackId);

        if (success) {
          // Update UI state
          currentTrack = trackId;
          currentCategory = category;
          isPlaying = true;

          updatePlayPauseButton();
          updateTrackItemStates();
          updateCurrentTrackDisplay();
          startProgressUpdate();
          startVisualizer();
          saveMusicPreferences();
        } else {
          console.log("üéµ Falling back to generated audio");
          // Fallback to generated audio
          generateFallbackAudio(trackId, category);
        }
      }

      // Audio URL function removed - now handled by AudioManager

      // Generate fallback audio data (demo implementation)
      function generateFallbackAudio(trackId, category) {
        console.log("üéµ Generating fallback audio for:", trackId);

        // Stop any existing audio context
        if (audioContext) {
          audioContext.close();
        }

        // Create new audio context
        audioContext = new (window.AudioContext || window.webkitAudioContext)();

        // Create multiple oscillators for more realistic sound
        const oscillators = [];
        const gainNodes = [];

        // Create different sound patterns based on track type
        const soundConfig = getSoundConfig(trackId, category);

        // Create oscillators for each frequency
        soundConfig.frequencies.forEach((freq, index) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();

          oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
          oscillator.type = soundConfig.waveType;

          // Add some randomness and modulation
          if (soundConfig.modulation) {
            const lfo = audioContext.createOscillator();
            const lfoGain = audioContext.createGain();

            lfo.frequency.setValueAtTime(
              soundConfig.modulation.rate,
              audioContext.currentTime
            );
            lfoGain.gain.setValueAtTime(
              soundConfig.modulation.depth,
              audioContext.currentTime
            );

            lfo.connect(lfoGain);
            lfoGain.connect(oscillator.frequency);
            lfo.start();
          }

          gainNode.gain.setValueAtTime(
            soundConfig.volumes[index] || 0.1,
            audioContext.currentTime
          );

          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);

          oscillators.push(oscillator);
          gainNodes.push(gainNode);
        });

        // Start all oscillators
        oscillators.forEach((osc) => osc.start());

        // Store reference for stopping
        currentAudio = {
          pause: () => {
            oscillators.forEach((osc) => osc.stop());
            if (audioContext) audioContext.close();
          },
          play: () => {
            // Restart the audio
            generateFallbackAudio(trackId, category);
          },
          currentTime: 0,
          duration: 60,
          volume: 0.5,
        };

        isPlaying = true;
        updatePlayPauseButton();
        updateTrackItemStates();
        startProgressUpdate();
        startVisualizer();
      }

      // Get sound configuration for different track types
      function getSoundConfig(trackId, category) {
        const configs = {
          // Nature sounds
          rain: {
            frequencies: [200, 300, 150, 250],
            volumes: [0.3, 0.2, 0.4, 0.1],
            waveType: "sawtooth",
            modulation: { rate: 0.5, depth: 50 },
          },
          forest: {
            frequencies: [400, 600, 800, 1000],
            volumes: [0.2, 0.3, 0.2, 0.1],
            waveType: "sine",
            modulation: { rate: 0.3, depth: 100 },
          },
          ocean: {
            frequencies: [100, 150, 200, 120],
            volumes: [0.4, 0.3, 0.2, 0.3],
            waveType: "triangle",
            modulation: { rate: 0.2, depth: 80 },
          },
          thunder: {
            frequencies: [60, 80, 100, 120],
            volumes: [0.5, 0.3, 0.2, 0.1],
            waveType: "square",
            modulation: { rate: 0.1, depth: 200 },
          },
          birds: {
            frequencies: [800, 1200, 1600, 2000],
            volumes: [0.2, 0.3, 0.2, 0.1],
            waveType: "sine",
            modulation: { rate: 2, depth: 200 },
          },
          wind: {
            frequencies: [80, 120, 160, 200],
            volumes: [0.3, 0.4, 0.2, 0.1],
            waveType: "sawtooth",
            modulation: { rate: 0.4, depth: 150 },
          },

          // Ambient sounds
          space: {
            frequencies: [50, 100, 150, 200],
            volumes: [0.4, 0.3, 0.2, 0.1],
            waveType: "sine",
            modulation: { rate: 0.1, depth: 100 },
          },
          city: {
            frequencies: [200, 400, 600, 800],
            volumes: [0.3, 0.3, 0.2, 0.2],
            waveType: "square",
            modulation: { rate: 0.8, depth: 50 },
          },
          cafe: {
            frequencies: [300, 500, 700, 900],
            volumes: [0.2, 0.3, 0.2, 0.1],
            waveType: "sine",
            modulation: { rate: 0.6, depth: 80 },
          },
          library: {
            frequencies: [150, 250, 350, 450],
            volumes: [0.2, 0.3, 0.2, 0.1],
            waveType: "triangle",
            modulation: { rate: 0.2, depth: 30 },
          },
          fireplace: {
            frequencies: [100, 150, 200, 250],
            volumes: [0.3, 0.4, 0.2, 0.1],
            waveType: "sawtooth",
            modulation: { rate: 0.3, depth: 100 },
          },
          train: {
            frequencies: [120, 180, 240, 300],
            volumes: [0.4, 0.3, 0.2, 0.1],
            waveType: "square",
            modulation: { rate: 0.5, depth: 60 },
          },

          // Focus sounds
          binaural: {
            frequencies: [440, 444, 448, 452],
            volumes: [0.3, 0.3, 0.2, 0.2],
            waveType: "sine",
            modulation: { rate: 0.1, depth: 10 },
          },
          classical: {
            frequencies: [261, 329, 392, 523],
            volumes: [0.3, 0.3, 0.2, 0.2],
            waveType: "sine",
            modulation: { rate: 0.05, depth: 20 },
          },
          lofi: {
            frequencies: [220, 330, 440, 550],
            volumes: [0.3, 0.3, 0.2, 0.2],
            waveType: "triangle",
            modulation: { rate: 0.3, depth: 40 },
          },
          piano: {
            frequencies: [261, 329, 392, 523],
            volumes: [0.3, 0.3, 0.2, 0.2],
            waveType: "sine",
            modulation: { rate: 0.1, depth: 30 },
          },
          "white-noise": {
            frequencies: [1000, 2000, 3000, 4000],
            volumes: [0.2, 0.2, 0.2, 0.2],
            waveType: "sawtooth",
            modulation: { rate: 10, depth: 500 },
          },
          "brown-noise": {
            frequencies: [500, 1000, 1500, 2000],
            volumes: [0.3, 0.3, 0.2, 0.2],
            waveType: "sawtooth",
            modulation: { rate: 5, depth: 300 },
          },

          // Relaxation sounds
          meditation: {
            frequencies: [220, 330, 440, 550],
            volumes: [0.2, 0.3, 0.2, 0.1],
            waveType: "sine",
            modulation: { rate: 0.05, depth: 20 },
          },
          spa: {
            frequencies: [200, 300, 400, 500],
            volumes: [0.2, 0.3, 0.2, 0.1],
            waveType: "triangle",
            modulation: { rate: 0.1, depth: 30 },
          },
          zen: {
            frequencies: [110, 220, 330, 440],
            volumes: [0.3, 0.3, 0.2, 0.1],
            waveType: "sine",
            modulation: { rate: 0.02, depth: 10 },
          },
          chimes: {
            frequencies: [523, 659, 784, 1047],
            volumes: [0.3, 0.3, 0.2, 0.2],
            waveType: "sine",
            modulation: { rate: 0.1, depth: 50 },
          },
          "singing-bowls": {
            frequencies: [220, 330, 440, 550],
            volumes: [0.3, 0.3, 0.2, 0.2],
            waveType: "sine",
            modulation: { rate: 0.05, depth: 40 },
          },
          flute: {
            frequencies: [440, 523, 659, 784],
            volumes: [0.3, 0.3, 0.2, 0.2],
            waveType: "sine",
            modulation: { rate: 0.2, depth: 30 },
          },
        };

        return (
          configs[trackId] || {
            frequencies: [440, 523, 659, 784],
            volumes: [0.3, 0.3, 0.2, 0.2],
            waveType: "sine",
            modulation: { rate: 0.1, depth: 20 },
          }
        );
      }

      // Initialize Audio Visualizer
      function initializeVisualizer() {
        console.log("üé® Initializing audio visualizer...");

        // Create audio context
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 256;

        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);

        console.log("üé® Visualizer initialized");
      }

      // Start visualizer animation
      function startVisualizer() {
        if (visualizerInterval) {
          clearInterval(visualizerInterval);
        }

        // Initialize visualizer if not already done
        if (!audioContext) {
          initializeVisualizer();
        }

        // Connect audio to analyser if we have a real audio element
        if (
          currentAudio &&
          currentAudio.src &&
          !currentAudio.src.includes("data:")
        ) {
          try {
            const source = audioContext.createMediaElementSource(currentAudio);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
          } catch (e) {
            console.log("üé® Using fallback visualizer");
          }
        }

        // Start animation loop
        visualizerInterval = setInterval(drawVisualizer, 100);
      }

      // Stop visualizer
      function stopVisualizer() {
        if (visualizerInterval) {
          clearInterval(visualizerInterval);
          visualizerInterval = null;
        }

        // Clear canvas
        const canvas = document.getElementById("visualizerCanvas");
        if (canvas) {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      // Draw visualizer
      function drawVisualizer() {
        const canvas = document.getElementById("visualizerCanvas");
        if (!canvas) return;

        const ctx = canvas.getContext("2d");
        const width = canvas.width;
        const height = canvas.height;

        // Clear canvas
        ctx.clearRect(0, 0, width, height);

        if (!isPlaying) {
          // Show static bars when not playing
          drawStaticVisualizer(ctx, width, height);
          return;
        }

        // Get frequency data
        if (analyser && dataArray) {
          analyser.getByteFrequencyData(dataArray);
          drawFrequencyBars(ctx, width, height, dataArray);
        } else {
          // Fallback: generate animated bars
          drawAnimatedBars(ctx, width, height);
        }
      }

      // Draw static visualizer (when not playing)
      function drawStaticVisualizer(ctx, width, height) {
        const barCount = 32;
        const barWidth = width / barCount;

        ctx.fillStyle = "rgba(255, 255, 255, 0.3)";

        for (let i = 0; i < barCount; i++) {
          const barHeight = Math.random() * height * 0.3;
          const x = i * barWidth;
          const y = height - barHeight;

          ctx.fillRect(x, y, barWidth - 2, barHeight);
        }
      }

      // Draw frequency bars from real audio data
      function drawFrequencyBars(ctx, width, height, dataArray) {
        const barCount = Math.min(32, dataArray.length);
        const barWidth = width / barCount;

        for (let i = 0; i < barCount; i++) {
          const dataIndex = Math.floor((i / barCount) * dataArray.length);
          const barHeight = (dataArray[dataIndex] / 255) * height;

          // Create gradient
          const gradient = ctx.createLinearGradient(
            0,
            height,
            0,
            height - barHeight
          );
          gradient.addColorStop(0, "rgba(255, 255, 255, 0.8)");
          gradient.addColorStop(0.5, "rgba(255, 255, 255, 0.6)");
          gradient.addColorStop(1, "rgba(255, 255, 255, 0.4)");

          ctx.fillStyle = gradient;

          const x = i * barWidth;
          const y = height - barHeight;

          ctx.fillRect(x, y, barWidth - 2, barHeight);
        }
      }

      // Draw animated bars (fallback when no real audio data)
      function drawAnimatedBars(ctx, width, height) {
        const barCount = 32;
        const barWidth = width / barCount;
        const time = Date.now() * 0.005;

        for (let i = 0; i < barCount; i++) {
          // Create wave-like animation
          const wave1 = Math.sin(time + i * 0.3) * 0.5 + 0.5;
          const wave2 = Math.sin(time * 1.5 + i * 0.2) * 0.3 + 0.3;
          const wave3 = Math.sin(time * 0.8 + i * 0.4) * 0.2 + 0.2;

          const barHeight = (wave1 + wave2 + wave3) * height * 0.8;

          // Create gradient based on track type
          const gradient = ctx.createLinearGradient(
            0,
            height,
            0,
            height - barHeight
          );
          if (currentCategory === "nature") {
            gradient.addColorStop(0, "rgba(34, 197, 94, 0.8)");
            gradient.addColorStop(1, "rgba(34, 197, 94, 0.4)");
          } else if (currentCategory === "ambient") {
            gradient.addColorStop(0, "rgba(59, 130, 246, 0.8)");
            gradient.addColorStop(1, "rgba(59, 130, 246, 0.4)");
          } else if (currentCategory === "focus") {
            gradient.addColorStop(0, "rgba(168, 85, 247, 0.8)");
            gradient.addColorStop(1, "rgba(168, 85, 247, 0.4)");
          } else if (currentCategory === "relax") {
            gradient.addColorStop(0, "rgba(236, 72, 153, 0.8)");
            gradient.addColorStop(1, "rgba(236, 72, 153, 0.4)");
          } else {
            gradient.addColorStop(0, "rgba(255, 255, 255, 0.8)");
            gradient.addColorStop(1, "rgba(255, 255, 255, 0.4)");
          }

          ctx.fillStyle = gradient;

          const x = i * barWidth;
          const y = height - barHeight;

          ctx.fillRect(x, y, barWidth - 2, barHeight);
        }
      }

      // Generate simple audio data (base64 encoded)
      function generateAudioData(trackId, category) {
        // This is a placeholder - in a real app you'd use actual audio files
        return "UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT";
      }

      // Toggle play/pause using audio manager
      function togglePlayPause() {
        if (!window.audioManager) return;

        if (window.audioManager.isAudioPlaying()) {
          // Pause the audio
          window.audioManager.pauseAudio();
          isPlaying = false;
          stopVisualizer();
          console.log("üéµ Audio paused");
        } else {
          // Resume the audio
          window.audioManager.resumeAudio();
          isPlaying = true;
          startVisualizer();
          console.log("üéµ Audio playing");
        }

        updatePlayPauseButton();
      }

      // Update play/pause button
      function updatePlayPauseButton() {
        const btn = document.getElementById("playPauseBtn");
        if (btn) {
          // Check audio manager state if available
          const audioPlaying = window.audioManager
            ? window.audioManager.isAudioPlaying()
            : isPlaying;
          btn.textContent = audioPlaying ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è";
        }
      }

      // Update progress bar
      function updateProgress() {
        // Get current audio from audio manager or fallback
        const audio = window.audioManager
          ? window.audioManager.currentAudio
          : currentAudio;
        if (!audio) return;

        const progressFill = document.getElementById("progressFill");
        const currentTimeEl = document.getElementById("currentTime");
        const totalTimeEl = document.getElementById("totalTime");

        if (progressFill && audio.duration) {
          const progress = (audio.currentTime / audio.duration) * 100;
          progressFill.style.width = progress + "%";
        }

        if (currentTimeEl) {
          currentTimeEl.textContent = formatTime(audio.currentTime || 0);
        }

        if (totalTimeEl) {
          totalTimeEl.textContent = formatTime(audio.duration || 0);
        }
      }

      // Start progress update interval
      function startProgressUpdate() {
        if (progressInterval) clearInterval(progressInterval);
        progressInterval = setInterval(updateProgress, 1000);
      }

      // Format time in MM:SS
      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins.toString().padStart(2, "0")}:${secs
          .toString()
          .padStart(2, "0")}`;
      }

      // Set volume using audio manager
      function setVolume(volume) {
        const volumeValue = document.getElementById("volumeValue");
        if (volumeValue) {
          volumeValue.textContent = volume + "%";
        }

        // Use audio manager to set volume
        if (window.audioManager) {
          window.audioManager.setVolume(volume / 100);
        }

        // Also set for fallback audio
        if (currentAudio) {
          currentAudio.volume = volume / 100;
        }

        localStorage.setItem("musicVolume", volume);
        console.log("üéµ Volume set to:", volume + "%");
      }

      // Switch category
      function switchCategory(category) {
        // Update active tab
        document.querySelectorAll(".category-tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        document
          .querySelector(`[data-category="${category}"]`)
          .classList.add("active");

        // Update active content
        document.querySelectorAll(".category-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`${category}-content`).classList.add("active");
      }

      // Update current track display
      function updateCurrentTrackDisplay() {
        const titleEl = document.getElementById("currentTrackTitle");
        const categoryEl = document.getElementById("currentTrackCategory");

        if (titleEl && currentTrack) {
          titleEl.textContent =
            currentTrack.charAt(0).toUpperCase() +
            currentTrack.slice(1).replace("-", " ");
        }

        if (categoryEl && currentCategory) {
          categoryEl.textContent =
            currentCategory.charAt(0).toUpperCase() + currentCategory.slice(1);
        }
      }

      // Update track item states
      function updateTrackItemStates() {
        document.querySelectorAll(".track-item").forEach((item) => {
          item.classList.remove("playing");
        });

        if (currentTrack && currentCategory) {
          const playingItem = document.querySelector(
            `[onclick="playTrack('${currentTrack}', '${currentCategory}')"]`
          );
          if (playingItem) {
            playingItem.classList.add("playing");
          }
        }
      }

      // Previous track
      function previousTrack() {
        if (currentPlaylist.length > 0) {
          currentPlaylistIndex =
            (currentPlaylistIndex - 1 + currentPlaylist.length) %
            currentPlaylist.length;
          const track = currentPlaylist[currentPlaylistIndex];
          playTrack(track.id, track.category);
        }
      }

      // Next track
      function nextTrack() {
        if (currentPlaylist.length > 0) {
          currentPlaylistIndex =
            (currentPlaylistIndex + 1) % currentPlaylist.length;
          const track = currentPlaylist[currentPlaylistIndex];
          playTrack(track.id, track.category);
        }
      }

      // Add current track to playlist
      function addToPlaylist() {
        if (!currentTrack || !currentCategory) return;

        const track = { id: currentTrack, category: currentCategory };

        // Check if already in playlist
        if (
          !currentPlaylist.some(
            (t) => t.id === track.id && t.category === track.category
          )
        ) {
          currentPlaylist.push(track);
          updatePlaylistDisplay();
          saveMusicPreferences();
        }
      }

      // Clear playlist
      function clearPlaylist() {
        currentPlaylist = [];
        currentPlaylistIndex = 0;
        updatePlaylistDisplay();
        saveMusicPreferences();
      }

      // Shuffle playlist
      function shufflePlaylist() {
        for (let i = currentPlaylist.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [currentPlaylist[i], currentPlaylist[j]] = [
            currentPlaylist[j],
            currentPlaylist[i],
          ];
        }
        currentPlaylistIndex = 0;
        updatePlaylistDisplay();
        saveMusicPreferences();
      }

      // Update playlist display
      function updatePlaylistDisplay() {
        const playlistEl = document.getElementById("playlist");
        if (!playlistEl) return;

        if (currentPlaylist.length === 0) {
          playlistEl.innerHTML =
            '<div class="playlist-empty">No tracks in playlist</div>';
          return;
        }

        playlistEl.innerHTML = currentPlaylist
          .map(
            (track, index) => `
          <div class="playlist-item ${
            index === currentPlaylistIndex ? "active" : ""
          }">
            <div class="playlist-item-info">
              <span>${
                track.id.charAt(0).toUpperCase() +
                track.id.slice(1).replace("-", " ")
              }</span>
              <span class="track-category">${track.category}</span>
            </div>
            <div class="playlist-item-actions">
              <button class="playlist-item-btn" onclick="playPlaylistTrack(${index})">‚ñ∂Ô∏è</button>
              <button class="playlist-item-btn" onclick="removeFromPlaylist(${index})">üóëÔ∏è</button>
            </div>
          </div>
        `
          )
          .join("");
      }

      // Play track from playlist
      function playPlaylistTrack(index) {
        currentPlaylistIndex = index;
        const track = currentPlaylist[index];
        playTrack(track.id, track.category);
      }

      // Remove track from playlist
      function removeFromPlaylist(index) {
        currentPlaylist.splice(index, 1);
        if (currentPlaylistIndex >= currentPlaylist.length) {
          currentPlaylistIndex = Math.max(0, currentPlaylist.length - 1);
        }
        updatePlaylistDisplay();
        saveMusicPreferences();
      }

      // Stop all audio using audio manager
      function stopAllAudio() {
        console.log("üéµ Stopping all audio...");

        if (window.audioManager) {
          window.audioManager.stopAudio();
        }

        if (audioContext) {
          audioContext.close();
          audioContext = null;
        }

        isPlaying = false;
        currentTrack = null;
        currentCategory = null;

        updatePlayPauseButton();
        updateTrackItemStates();
        stopVisualizer();

        if (progressInterval) {
          clearInterval(progressInterval);
          progressInterval = null;
        }

        console.log("üéµ All audio stopped");
      }

      // Close music modal
      function closeMusicModal() {
        const modal = document.getElementById("musicModal");
        if (modal) {
          document.body.removeChild(modal);
        }

        // Stop all audio
        stopAllAudio();
      }

      // Test functions - call from browser console
      window.testDefocusLock = function () {
        console.log("üß™ Testing defocus lock...");
        console.log("Current state:", sessionState);
        startDefocusSession("test", 5);
        console.log("After start:", sessionState);
      };

      window.testDefocusUnlock = function () {
        console.log("üß™ Testing defocus unlock...");
        console.log("Current state:", sessionState);
        endFocusSession();
        console.log("After end:", sessionState);
      };

      window.getSessionState = function () {
        console.log("üìä Current session state:", sessionState);
        return sessionState;
      };
    </script>
  </body>
</html>
